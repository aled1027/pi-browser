{
  "id": "0cb6b6b3",
  "title": "Add dynamic extension/skill registration to Agent API (post-initialization)",
  "tags": [
    "feature",
    "api",
    "agent"
  ],
  "status": "done",
  "created_at": "2026-02-12T22:36:16.425Z"
}

## Completed

All 8 implementation steps done. Build passes cleanly.

### Changes made:

1. **`src/core/storage.ts`** — Added agent-level VFS persistence (`saveVFS`/`loadVFS`) with its own IndexedDB store (`agent-vfs`). Bumped DB version to 2. Removed per-thread FS from `deleteThread()`.

2. **`src/core/extensions.ts`** — Changed `Extension` type from `(api: PiBrowserAPI) => void` to `(agent: ExtensionHost) => void`. Added `ExtensionHost` interface. Moved `registerTool`, `on`, `requestUserInput` to public methods on `ExtensionRegistry`. Added tool-origin tracking (`toolOwnership` map) and `unregisterToolsByExtension()`. Changed `load()` to accept `ExtensionHost`. Kept `PiBrowserAPI` as deprecated.

3. **`src/core/skills.ts`** — Added `unregister(name)` method to `SkillRegistry`. Added `parseSkillMarkdown()` and `serializeSkillMarkdown()` functions for YAML frontmatter parsing/serialization.

4. **`src/core/agent.ts`** — Agent now implements `ExtensionHost`. VFS is per-agent (shared across threads). Removed VFS save/restore from thread operations. Added `addExtension()`, `removeExtension()`, `addSkill()`, `removeSkill()`. Added `initAsync()` that loads VFS from storage, auto-loads extensions from `/.pi-browser/extensions/*.js`, auto-loads skills from `/.pi-browser/skills/*.md`, then loads config extensions. Split persistence into `persistMessages()` and `persistVFS()`.

5. **`src/core/plugins/extensions/ask-user.ts`** — Updated to use `agent` parameter instead of `api`.

6. **`src/core/plugins/skills/pi-browser.ts`** — Updated skill content to document new APIs (ExtensionHost, dynamic extensions/skills, VFS-per-agent).

7. **`src/core/index.ts`** — Added exports for `ExtensionHost`, `parseSkillMarkdown`, `serializeSkillMarkdown`.

8. **`docs/pi-browser-core.md`** — Full rewrite to document new APIs, VFS-per-agent architecture, dynamic extension/skill management.

9. **`examples/tutor/src/plugins/run-code.ts`** — Updated parameter name from `api` to `agent`.
