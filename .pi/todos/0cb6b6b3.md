{
  "id": "0cb6b6b3",
  "title": "Add dynamic extension/skill registration to Agent API (post-initialization)",
  "tags": [
    "feature",
    "api",
    "agent"
  ],
  "status": "open",
  "created_at": "2026-02-12T22:36:16.425Z"
}

## Goal

Update the pi-browser Agent API so users can add extensions and skills **after** the agent is initialized, persist them to VFS for automatic future loading, and support removal.

## Architecture Changes

### VFS is per-agent, not per-thread
- **Change**: VFS is shared across all threads and persisted independently (its own IndexedDB store, not tied to thread state).
- **Threads only persist messages.** Thread switching no longer saves/restores VFS.
- Remove VFS save/restore from `switchThread()`, `newThread()`, `deleteThread()`, `persist()`, `restoreOrCreateThread()`, and `serialize()`.
- Add separate VFS persistence that saves/loads independently of threads.

### Extension type signature change
- **Change `Extension` from `(api: PiBrowserAPI) => void` to `(agent: Agent) => void`.**
- Move `registerTool`, `on("agent_event", ...)`, and `requestUserInput` onto `Agent` directly (or keep them and also expose agent).
- Update `ExtensionRegistry` to pass `Agent` instead of `PiBrowserAPI`.
- Update all existing extensions (`ask-user.ts`) to accept `Agent`.
- `PiBrowserAPI` can be removed or kept as a subset — but the extension signature changes.

## New Agent Methods

### `addExtension(source: string, filename: string): void`
- Eval the source as a function: `const fn = eval(source)` — expects `(agent) => { ... }`.
- Execute `fn(agent)` immediately to register tools, etc.
- Write the source to `/.pi-browser/extensions/<filename>.js` on VFS.
- Persist VFS.

### `removeExtension(name: string): void`
- Unregister all tools that were registered by this extension.
- Delete `/.pi-browser/extensions/<name>.js` from VFS.
- Persist VFS.
- **Requires**: `ExtensionRegistry` tracks which tools came from which extension.

### `addSkill(skill: Skill): void`
- Register the skill in `SkillRegistry` immediately.
- Write to `/.pi-browser/skills/<name>.md` as markdown with YAML frontmatter.
- Persist VFS.

### `removeSkill(name: string): void`
- Unregister from `SkillRegistry`.
- Delete `/.pi-browser/skills/<name>.md` from VFS.
- Persist VFS.

## VFS File Formats

### Extensions: `/.pi-browser/extensions/<name>.js`
```js
(agent) => {
  agent.registerTool({
    name: "fetch_url",
    description: "Fetch a URL and return its text content",
    parameters: {
      type: "object",
      properties: { url: { type: "string" } },
      required: ["url"],
    },
    execute: async (args) => {
      const text = await (await fetch(args.url)).text();
      return { content: text.slice(0, 5000), isError: false };
    },
  });
}
```

### Skills: `/.pi-browser/skills/<name>.md`
```markdown
---
name: api-design
description: Design RESTful APIs. Use when asked to design or review an API.
---
# API Design Guidelines

## URL Structure
- Use nouns for resources...
```

## Auto-Loading on Startup

On `Agent.create()` / `ready()`:
1. Load persisted VFS from its own storage.
2. Scan `/.pi-browser/extensions/*.js` — eval and execute each.
3. Scan `/.pi-browser/skills/*.md` — parse frontmatter + body, register each.
4. No reporting/callbacks needed — load silently.

## ExtensionRegistry Changes

- Track which tools were registered by which extension (e.g. `Map<extensionName, toolName[]>`).
- Add `unregisterToolsByExtension(name: string)` method.
- Change `load()` to pass `Agent` instead of building a `PiBrowserAPI`.

## Files to Change

1. **`src/core/agent.ts`** — VFS per-agent persistence, new methods (`addExtension`, `removeExtension`, `addSkill`, `removeSkill`), remove VFS from thread save/restore, auto-load from VFS on startup, expose `registerTool`/`on`/`requestUserInput` directly.
2. **`src/core/extensions.ts`** — Change `Extension` type to `(agent: Agent) => void`, remove `PiBrowserAPI` (or deprecate), add tool-origin tracking + unregister support.
3. **`src/core/skills.ts`** — Add `unregister(name)` method to `SkillRegistry`.
4. **`src/core/storage.ts`** — Add VFS storage methods independent of threads, remove VFS from thread storage.
5. **`src/core/plugins/extensions/ask-user.ts`** — Update to accept `Agent` instead of `PiBrowserAPI`.
6. **`src/core/plugins/skills/pi-browser.ts`** — Update skill content to document new APIs.
7. **`src/core/index.ts`** — Update exports (remove `PiBrowserAPI` or keep as deprecated).
8. **`docs/pi-browser-core.md`** — Update docs for new APIs, VFS-per-agent, extension signature change.
9. **Tests** (if any) — update accordingly.

## Order of Implementation

1. VFS per-agent storage (decouple from threads)
2. Extension type signature change (`Agent` instead of `PiBrowserAPI`)
3. Tool-origin tracking in `ExtensionRegistry`
4. `SkillRegistry.unregister()`
5. Skill markdown frontmatter parser
6. `addExtension` / `removeExtension` / `addSkill` / `removeSkill` on Agent
7. Auto-load from VFS on startup
8. Update existing extensions, skill content, docs
